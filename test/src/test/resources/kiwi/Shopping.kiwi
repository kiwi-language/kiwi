import java.util.List
import java.util.ArrayList
import java.lang.RuntimeException

@Searchable
class Product {
    private var name: string
    private val skuList: ArrayList<SKU>

    init(name: string, skuList: List<SKU>) {
        this.name = name
        this.skuList = new ArrayList<SKU>(skuList)
    }

    func getName() -> string {
        return this.name
    }

    func setName(name: string) {
        this.name = name
    }

    func getSkuList() -> List<SKU> {
        return new ArrayList<SKU>(this.skuList)
    }

    func setSkuList(skuList: List<SKU>) {
        this.skuList.clear()
        this.skuList.addAll(skuList)
    }

}

class SKU {

    private var name: string
    private var price: double
    private var quantity: int

    init(name: string, price: double, quantity: int) {
        this.name = name
        this.price = price
        this.quantity = quantity
    }

    func decQuantity(quantity: int) {
        if (this.quantity < quantity) {
            throw new RuntimeException("Out of inventory")
        }
        this.quantity = this.quantity - quantity
    }

    func buy(quantity: int, coupons: List<Coupon>) -> Order {
        this.decQuantity(quantity)
        var size = coupons.size()
        var i = 0
        var totalDiscount = 0.0
        while (i < size) {
            var coupon = coupons.get(i)!!
            var discount = coupon.use()
            i = i + 1
            totalDiscount = totalDiscount + discount
        }
        return new Order(this.name, quantity, this.price * (quantity as double) - totalDiscount, this, coupons)
    }

    func getName() -> string {
        return this.name
    }

    func setName(name: string) {
        this.name = name
    }

    func getPrice() -> double {
        return this.price
    }

    func setPrice(price: double) {
        this.price = price
    }

    func getQuantity() -> int {
        return this.quantity
    }

    func setQuantity(quantity: int) {
        this.quantity = quantity
    }

}

class Coupon {
    private val name: string
    private val discount: double
    private var state: CouponState

    init(name: string, discount: double) {
        this.name = name
        this.discount = discount
        this.state = CouponState.NORMAL
    }

    func getName() -> string {
        return this.name
    }

    func getDiscount() -> double {
        return this.discount
    }

    func getState() -> CouponState {
        return this.state
    }

    func use() -> double {
        if(this.state == CouponState.USED) {
            throw new RuntimeException("Coupon already used")
        }
        this.state = CouponState.USED
        return this.discount
    }

}

enum CouponState {
    NORMAL,
    USED

;

    init() {
    }

}

@Searchable
class Order {
    private val code: string
    private val quantity: int
    private val price: double
    private val sku: SKU
    private val coupons: List<Coupon>
    private val orderTime: time

    init(code: string, quantity: int, price: double, sku: SKU, coupons: List<Coupon>) {
        this.code = code
        this.quantity = quantity
        this.price = price
        this.sku = sku
        this.coupons = new ArrayList<Coupon>(coupons)
        this.orderTime = now()
    }

    func getCode() -> string {
        return this.code
    }

    func getQuantity() -> int {
        return this.quantity
    }

    func getPrice() -> double {
        return this.price
    }

    func getSku() -> SKU {
        return this.sku
    }

    func getTime() -> time {
        return this.orderTime
    }

    func getCoupons() -> List<Coupon> {
        return new ArrayList<Coupon>(this.coupons)
    }

}
