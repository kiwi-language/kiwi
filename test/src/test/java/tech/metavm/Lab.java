package tech.metavm;

import tech.metavm.object.instance.core.Id;
import tech.metavm.object.instance.core.PhysicalId;
import tech.metavm.object.instance.core.TaggedPhysicalId;
import tech.metavm.object.type.TypeOrTypeKey;
import tech.metavm.util.*;

import java.io.ByteArrayInputStream;
import java.io.IOException;

public class Lab {

    public static final String hex = "0C9CD903BA020B001802E0D40300282804E0D40338B60203124D6574686F64526566BA020334746563682E6D657461766D2E666C6F772E4D6574686F64526566C4020A02E6D403002ACA020400CE020400D2020A02EED4030038FA020400FE020400820304009003040094030A029CD9035A8801AC030A0290D503007AB2030400B6030400BA030400BE030BB2021618028CD503002878020B5A18028ED903002888010680D5030C1A0318E9A284E8AEBEE8A786E59BBE1E030E6275696C74696E280A029CD9036440340A029CD903860140400B601802E8D40300283602E8D40304100A029CD9031E28160B62161802F2D40300283200460B5C1802E8D40300283602E8D40304100A029CD9030028160B5E161802F2D403002832008CD50306600401640A029CD90300288A010BD4011518028CD503002878008ED903080C0BD601161802A6D90300288201060BD8011802A8D9030028840104A6D903060A0A029CD9035A8801100BE0011802ACD9030028CC0202ACD903020C0BE2011802E8D40300283602E8D40304100A0298D5030028160BE401161802F2D403002832001C0BDA011802AAD9030028860102AAD90304360BDC011802E8D40300283602E8D40304100A029CD9031E28160BDE01161802F2D403002832003C0A029CD903261CA8D90302140A02B8D9030A1C0BE6011802A8D9030028840104A6D903060A0A029CD9035A8801100BEE011802BED90300289E0302BED903060C0BF0011802F8D8030028C60202F8D803040C0BF2011802E8D40300283602E8D40304100A02F2D4030028160BF401161802F2D40300283200120A02C2D80300C802120BF6011802F8D8030028C60202F8D803040C0BF8011802E8D40300283602E8D40304100A02F2D4030228160BFA01161802F2D40300283200120A02C2D80300C802180BFC011802C0D9030028EC0202C0D903020C0BFE011802C2D9030028EA0102C2D90304100B80021802E8D40300283602E8D40304100A02F2D4030028160B8202161802F2D40300283200160A02F2D4031E88011C0BE8011802AAD9030028860102AAD90304360BEA011802E8D40300283602E8D40304100A029CD9031E28160BEC01161802F2D403002832003C0A029CD9032C1CA8D90302140A02B8D903101C0B84021802A8D9030028840104A6D903060A0A029CD9035A8801100BB4021802ACD9030028CC0202ACD903020C0BB6021802E8D40300283602E8D40304100A02E8D4030028160BB802161802F2D403002832001C0B86021802AAD9030028860102AAD90304360B88021802E8D40300283602E8D40304100A029CD9031E28160B8A02161802F2D403002832003C0A029CD903341CA8D90302140A029CD903101C140B1E1802E0D40300282804E0D40334B602032A4D6574686F64526566E9A284E8AEBEE8A786E59BBEBA0203284D6574686F645265666275696C74696E56696577C4020A02E6D403002ACA020401CE020401D2020A028ED6030038FA020400FE0204008203040090030400AC030A0290D503007AB2030400B6030401BA030400BE030B4A1618028CD50300287800C6030B481618028AD50300287200CE030B46151802E0D40300282800D6030B44161802F2D40300283200DE030B4216180288D50300285400E6030B40161802FCD40300286E00EE030B3E16180284D50300281C00F6030B3C16180286D50300284000FE030B3A16180286D5030028400086040B2416180284D50300281C060B26180284D50300281C0284D5031618030E726177466C6F771C030E726177466C6F77260A029CD9031E282C0A02A6D5030062320400400400440A02AAD503007C4A0400700401740A02B4D50300567A0B281802E8D40300283602E8D40304100A0298D5030028160B2A161802F2D403002832000B2C180284D50300281C0284D5031618031A74797065417267756D656E74731C031A74797065417267756D656E7473260A029CD9031E282C0A02A6D5030062320400400400440A02FCD803007C4A0401700401740A02B4D50300567A0B2E1802F8D8030028C60202F8D803040C0B301802E8D40300283602E8D40304100A02F2D4030228160B32161802F2D40300283200120A02C2D80300C8020B34180284D50300281C0284D5031618031A6465636C6172696E67547970651C031A6465636C6172696E6754797065260A029CD9031E282C0A02A6D5030062320400400400440A0282D903007C4A0401700401740A02B4D50300567A0B361802E8D40300283602E8D40304100A02E8D4030028160B38161802F2D403002832008E040B22151802E0D4030028280096040B20161802E8D4030028360094D503020A0401200A029CD90318402C0A029CD903940140C6030BB0021618028AD50300287200CE030BAE02151802E0D40300282800D6030BAC02161802F2D40300283200DE030BAA0216180288D50300285400E6030BA802161802FCD40300286E00EE030BA60216180284D50300281C00F6030BA40216180286D50300284000FE030B1616180286D503002840080B18180286D5030028400486D50312140A029CD90300281A04001E0A02A6D5030062240B96021618029CD90300286C002C0400300400400B9802180298D90300285A0298D90304340B9A021802E8D40300283602E8D40304100A029CD9031E28160B9C02161802F2D403002832003A0B9E02161802F2D403002832020BA0021802E8D40300283602E8D40304100A029CD9030028160BA202161802F2D403002832004C040050040098D5031A0E0332E88EB7E58F96E8A786E59BBE24E9A284E8AEBEE8A786E59BBE12031E67657456696577246275696C74696E1C0400200401240400340A02B4D5030056440A029CD9035A8801500B94021618029AD90300285E00580B52180298D90300285A0298D90304340B541802E8D40300283602E8D40304100A029CD9031E28160B56161802F2D403002832003A0B58161802F2D403002832005E0B50161802F2D40300283200660B4E16180288D503002854007A0B1C1802E8D40300283602E8D40304100A029CD9031E28160B4C161802F2D4030028320080010B1A16180286D903002842000B9401180286D5030028400486D50312140A029CD90300281A04001E0A02A6D5030062240BB0011618029CD90300286C002C0400300400400BB201180298D90300285A0298D90304340BB4011802E4D80300289C0202E4D803020C0A02A8D803009E023A0BB601161802F2D403002832040BB8011802E8D40300283602E8D40304100A029CD9030028160BBA01161802F2D403002832000BBC011802E8D40300283602E8D40304100A029CD9031E28160BBE01161802F2D403002832004C040050040098D5031A0E0332E4BF9DE5AD98E8A786E59BBE24E9A284E8AEBEE8A786E59BBE1203207361766556696577246275696C74696E1C0400200401240400340A02B4D5030056440A029CD9035A8801500BAE011618029AD90300285E00580BA401180298D90300285A0298D90304340BA6011802E4D80300289C0202E4D803020C0A02A8D803009E023A0BA801161802F2D403002832020BAA011802E8D40300283602E8D40304100A029CD9031E28160BAC01161802F2D403002832005E0BA201161802F2D40300283200660BA00116180288D503002854007A0B9E011802E4D80300289C0202E4D803020C0A02A8D803009E0280010B960116180286D903002842020B9801180286D9030028420286D9030814030CE8A786E59BBE18030856696577220B9A011802E8D40300283602E8D40304100A029CD9031E28160B9C01161802F2D40300283200340A029CD9039401400B64180286D5030028400486D50310140A029CD90300281A04011E0A02A6D5030062240B84011618029CD90300286C002C04003004004C040050040098D5031A0E033AE698A0E5B084244D6574686F645265665FE9A284E8AEBEE8A786E59BBE12034C6D617024746563685F6D657461766D5F666C6F775F4D6574686F645265665F6275696C74696E1C0400200401240400340A02B4D5030056440A029CD9035A8801500B82011618029AD90300285E00580B76180298D90300285A0298D90304340B781802E8D40300283602E8D40304100A029CD9031E28160B7A161802F2D403002832003A0B7C161802F2D403002832020B7E1802E8D40300283602E8D40304100A029CD9030028160B8001161802F2D403002832005E0B74161802F2D40300283200660B7216180288D503002854007A0B6E1802E8D40300283602E8D40304100A029CD9031E28160B70161802F2D4030028320080010B6616180286D903002842020B68180286D9030028420286D9030814030CE69DA5E6BA9018030C736F75726365220B6A1802E8D40300283602E8D40304100A029CD9030028160B6C161802F2D40300283200340A029CD90364400B8601180286D5030028400486D50310140A029CD90300281A04011E0A02A6D5030062240BD2011618029CD90300286C002C04003004004C040050040098D5031A0E0340E58F8DE698A0E5B084244D6574686F645265665FE9A284E8AEBEE8A786E59BBE120350756E6D617024746563685F6D657461766D5F666C6F775F4D6574686F645265665F6275696C74696E1C0400200401240400340A02B4D5030056440A029CD9035A8801500BD0011618029AD90300285E00580BC401180298D90300285A0298D90304340BC6011802E8D40300283602E8D40304100A029CD9030028160BC801161802F2D403002832003A0BCA01161802F2D403002832020BCC011802E8D40300283602E8D40304100A029CD9031E28160BCE01161802F2D403002832005E0BC201161802F2D40300283200660BC00116180288D503002854007A0B90011802E8D40300283602E8D40304100A029CD9030028160B9201161802F2D4030028320080010B880116180286D903002842020B8A01180286D9030028420286D9030814030CE8A786E59BBE18030876696577220B8C011802E8D40300283602E8D40304100A029CD9031E28160B8E01161802F2D40300283200340A029CD90386014086040B0E16180284D50300281C020B10180284D50300281C0284D5031618031A6465636C6172696E67547970651C031A6465636C6172696E6754797065260A029CD90300282C0A02A6D5030062320400400400440A02AAD503007C4A0401700401740A02B4D50300567A0B121802E8D40300283602E8D40304100A02E8D4030028160B14161802F2D403002832008E040B0C151802E0D4030028280096040B06161802E8D403002836020B081802E8D40300283602E8D40304100A02B2D9030028160B0A161802F2D403002832009E040B021802E8D40300283602E8D40304100A02B8D9030028160B04161802F2D4030028320094D503020A0401";

    public static void main(String[] args) throws IOException {
        var id = (TaggedPhysicalId) Id.parse("01f0b7cbdc0d00");
//        var rootId = new TaggedPhysicalId(id.getTreeId(), 0L, 20);
//        System.out.println(id.getClass().getName());
        System.out.println("treeId: " + id.getTreeId());
        System.out.println("nodeId: " + id.getNodeId());
        System.out.println("typeTag: " + id.getTypeTag());
//        System.out.println(rootId);
        var bytes = EncodingUtils.hexToBytes(hex);
//        System.out.println(NncUtils.toPrettyJsonString(BytesUtils.convertToJSON(bytes, true)));

        new StreamVisitor(new ByteArrayInputStream(bytes)) {

            private final LinkedList<Id> path = new LinkedList<>();

            @Override
            public void visitRecordBody(long nodeId, TypeOrTypeKey typeOrTypeKey) {
                var curId = PhysicalId.of(getTreeId(), nodeId, typeOrTypeKey);
                path.addLast(curId);
                if (curId.equals(id)) {
                    System.out.println(NncUtils.join(path, Id::toString, "->"));
                    System.out.println(NncUtils.join(path, id -> id instanceof TaggedPhysicalId tpId ? tpId.getTypeTag() + "" : "0", "->"));
                }
                super.visitRecordBody(nodeId, typeOrTypeKey);
                path.removeLast();
            }
        }.visitMessage();

    }


}
