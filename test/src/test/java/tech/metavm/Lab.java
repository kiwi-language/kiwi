package tech.metavm;

import tech.metavm.object.instance.core.Id;
import tech.metavm.object.instance.core.PhysicalId;
import tech.metavm.object.instance.core.TaggedPhysicalId;
import tech.metavm.object.type.TypeOrTypeKey;
import tech.metavm.util.*;

import java.io.ByteArrayInputStream;
import java.io.IOException;

public class Lab {

    public static final String hex = "04A6F30FDE030B001802A0EF0F00282804A0EF0F38F8010324E7B1BBE59E8BE8BDACE68DA2E88A82E782B9FC010332746563682E6D657461766D2E666C6F772E436173744E6F646586020A02CCEF0F002A8C0204009002040094020A02D8EF0F0038BC020400C0020400C4020400D2020400E2020A02A6F30F960188018C030A02DEF00F007A960304009E030400A6030400AA030BDC03161802DAF00F002878020B96011802D2F10F0028880106DAF00F06420401460A02A6F30F0028760B9602151802DAF00F00287800ACF10F0C1E0318E9A284E8AEBEE8A786E59BBE22030E6275696C74696E2C0A02A6F30FA00140380A02A6F30FC20140440B9C011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B9E01161802BEEF0F002832004A0B98011802CEEF0F00283602CEEF0F04100A02A6F30F0028160B9A01161802BEEF0F00283200D2F10F080C0B9802161802E0F10F00288201120B9A021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BA2021802F2F10F0028CC0202F2F10F020C0BA4021802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E021C0B9C021802C8F10F0028860102C8F10F04100B9E021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BA002161802BEEF0F00283200160A02A6F30F221CF0F10F02140A028CF20F90011C0BA6021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BAE021802F2F10F0028CC0202F2F10F020C0BB0021802FCEF0F0028980202FCEF0F020C0BB202161802BEEF0F002832040BB4021802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020BB6021802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E021C0BA8021802C8F10F0028860102C8F10F04100BAA021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BAC02161802BEEF0F00283200160A02A6F30F261CF0F10F02140A028CF20F94011C0BB8021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BC0021802F2F10F0028CC0202F2F10F020C0BC2021802CEEF0F00283602CEEF0F04100A0290F00F0028160BC402161802BEEF0F002832001C0BBA021802C8F10F0028860102C8F10F04100BBC021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BBE02161802BEEF0F00283200160A02A6F30F301CF0F10F02140A028CF20F9E011C0BC6021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BCE0218029EF20F00289602029EF20F060C0BD0021802FCEF0F0028980202FCEF0F020C0BD202161802BEEF0F002832040B88011802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B84011802CEEF0F00283602CEEF0F04100A02BEEF0F0028160B8601161802BEEF0F00283200120BD4021802FCEF0F0028980202FCEF0F020C0BD602161802BEEF0F002832040BDC011802CEEF0F00283602CEEF0F04100A02BEEF0F0428160BDE01161802BEEF0F002832000BE0011802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E02180BD802161802DAEF0F00288A01040BDA021802F2F10F0028CC0202F2F10F020C0BDC021802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020BDE021802F6F10F0028EC0202F6F10F020C0BE0021802F8F10F0028EA0102F8F10F04100BE2021802CEEF0F00283602CEEF0F04100A02BEEF0F0028160BE402161802BEEF0F00283200160A02BEEF0F1E88011C0BC8021802C8F10F0028860102C8F10F04100BCA021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BCC02161802BEEF0F00283200160A02A6F30F361CF0F10F02140A028CF20FCC011C0BE6021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BEE021802F2F10F0028CC0202F2F10F020C0BF0021802CEEF0F00283602CEEF0F04100A0292F20F0028160BF202161802BEEF0F002832001C0BE8021802C8F10F0028860102C8F10F04100BEA021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BEC02161802BEEF0F00283200160A02A6F30F421CF0F10F02140A028CF20FA4011C0BF4021802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BFC021802F2F10F0028CC0202F2F10F020C0BFE021802FCEF0F0028980202FCEF0F020C0B8003161802BEEF0F002832040B82031802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B84031802CEEF0F00283602CEEF0F04100A028CF20F0028160B8603161802BEEF0F002832001C0BF6021802C8F10F0028860102C8F10F04100BF8021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BFA02161802BEEF0F00283200160A02A6F30F481CF0F10F02140A028CF20FAA011C0B88031802F0F10F0028840104E0F10F060A0A02A6F30F96018801100B90031802F2F10F0028CC0202F2F10F020C0B92031802FCEF0F0028980202FCEF0F020C0B9403161802BEEF0F002832040B96031802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B98031802CEEF0F00283602CEEF0F04100A028CF20F0028160B9A03161802BEEF0F002832001C0B8A031802C8F10F0028860102C8F10F04100B8C031802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B8E03161802BEEF0F00283200160A02A6F30F541CF0F10F02140A028CF20FB6011C0B9C031802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BA4031802F2F10F0028CC0202F2F10F020C0BA6031802FCEF0F0028980202FCEF0F020C0BA803161802BEEF0F002832040BAA031802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020BAC031802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E021C0B9E031802C8F10F0028860102C8F10F04100BA0031802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BA203161802BEEF0F00283200160A02A6F30F601CF0F10F02140A028CF20FC2011C0BAE031802F0F10F0028840104E0F10F060A0A02A6F30F96018801100BB6031802F6F10F0028EC0202F6F10F020C0BB8031802F8F10F0028EA0102F8F10F04100BBA031802CEEF0F00283602CEEF0F04100A0282F00F0028160BBC03161802BEEF0F00283200160A0282F00F3088011C0BB0031802C8F10F0028860102C8F10F04100BB2031802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BB403161802BEEF0F00283200160A02A6F30F6A1CF0F10F02140A02A6F30F0C1C140B1A1802A0EF0F00282804A0EF0F36F801033CE7B1BBE59E8BE8BDACE68DA2E88A82E782B9E9A284E8AEBEE8A786E59BBEFC010326436173744E6F64656275696C74696E5669657786020A02CCEF0F002A8C0204019002040194020A0288F00F0038A4020A02A6F30F221CBC020400C0020400C4020400D20204008C030A02DEF00F007A960304009E030401A6030400AA030B8001161802DAF00F00287800B2030B7E161802D8F00F00287200BA030B7C151802A0EF0F00282800C2030B7A161802BEEF0F00283200CA030B78161802BCEF0F00285400D2030B76161802E4EF0F00286E00DA030B74161802E8EF0F00281C00E2030B7216180286F00F00284000EA030B7016180286F00F00284000F2030B20161802E8EF0F00281C120B221802E8EF0F00281C02E8EF0F1618030CE5908DE7A7B01C03086E616D65260A02A6F30F1A282C0A02ECEF0F0062320400400400440A02F6EF0F007CEA0104009002040094020A02C2EF0F00569A020B241802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E020B261802E8EF0F00281C02E8EF0F1618030CE7BC96E58FB71C0308636F6465260A02A6F30F1A282C0A02ECEF0F0062320400400400440A02FAEF0F007CEA0104009002040094020A02C2EF0F00569A020B281802FCEF0F0028980202FCEF0F020C0B2A161802BEEF0F002832040B2C1802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B2E1802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E020B301802E8EF0F00281C02E8EF0F1618030CE7B1BBE588AB1C03086B696E64260A02A6F30F1A282C0A02ECEF0F0062320400400400440A02EEEF0F007CEA0104009002040194020A02C2EF0F00569A020B321802CEEF0F00283602CEEF0F04100A0290F00F0028160B34161802BEEF0F002832000B361802E8EF0F00281C02E8EF0F16180318E8BE93E587BAE7B1BBE59E8B1C03146F757470757454797065260A02A6F30F1A282C0A02ECEF0F0062320400400400440A0280F00F007CEA0104019002040094020A02C2EF0F00569A020B381802FCEF0F0028980202FCEF0F020C0B3A161802BEEF0F002832040B3C1802CEEF0F00283602CEEF0F04100A02BEEF0F0428160B3E161802BEEF0F002832000B401802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B421802E8EF0F00281C02E8EF0F16180318E68980E5B19EE88C83E59BB41C030A73636F7065260A02A6F30F1A282C0A02ECEF0F0062320400400400440A0280F20F007CEA0104009002040194020A02C2EF0F00569A020B441802CEEF0F00283602CEEF0F04100A0292F20F0028160B46161802BEEF0F002832000B481802E8EF0F00281C02E8EF0F1618030CE5898DE9A9B11C03167072656465636573736F72260A02A6F30F1A282C0A02ECEF0F0062320400400400440A0294F20F007CEA0104009002040094020A02C2EF0F00569A020B4A1802FCEF0F0028980202FCEF0F020C0B4C161802BEEF0F002832040B4E1802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B501802CEEF0F00283602CEEF0F04100A028CF20F0028160B52161802BEEF0F002832000B541802E8EF0F00281C02E8EF0F1618030CE5908EE7BBA71C0312737563636573736F72260A02A6F30F1A282C0A02ECEF0F0062320400400400440A0296F20F007CEA0104009002040094020A02C2EF0F00569A020B561802FCEF0F0028980202FCEF0F020C0B58161802BEEF0F002832040B5A1802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B5C1802CEEF0F00283602CEEF0F04100A028CF20F0028160B5E161802BEEF0F002832000B601802E8EF0F00281C02E8EF0F1618030CE99499E8AFAF1C030A6572726F72260A02A6F30F1A282C0A02ECEF0F0062320400400400440A0298F20F007CEA0104009002040094020A02C2EF0F00569A020B621802FCEF0F0028980202FCEF0F020C0B64161802BEEF0F002832040B661802B6EF0F00289C0202B6EF0F020C0A02FEEF0F009E020B681802B6EF0F00289C0202B6EF0F020C0A02F8EF0F009E020B6A1802E8EF0F00281C02E8EF0F16180306E580BC1C030C6F626A656374260A02A6F30F1A282C0A02ECEF0F0062320400400400440A02A0F20F007CEA0104019002040094020A02C2EF0F00569A020B6C1802CEEF0F00283602CEEF0F04100A0282F00F0A28160B6E161802BEEF0F00283200FA030B1E151802A0EF0F0028280082040B1C161802CEEF0F00283600A8F10F020A0401200A02A6F30F14402C0A02A6F30FD00140B2030BDA03161802D8F00F00287200BA030BD803151802A0EF0F00282800C2030BD603161802BEEF0F00283200CA030BD403161802BCEF0F00285400D2030BD203161802E4EF0F00286E00DA030BD003161802E8EF0F00281C00E2030BCE0316180286F00F00284000EA030B1216180286F00F002840080B14180286F00F0028400486F00F12140A02A6F30F00281A04001E0A02ECEF0F0062240BC003161802C4F10F00286C002C0400300400400BC2031802C4EF0F00285A02C4EF0F040C0BC4031802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BC603161802BEEF0F00283200120BC803161802BEEF0F002832020BCA031802CEEF0F00283602CEEF0F04100A02A6F30F0028160BCC03161802BEEF0F002832004C0400500400A4F10F1A0A0332E88EB7E58F96E8A786E59BBE24E9A284E8AEBEE8A786E59BBE0E031E67657456696577246275696C74696E1804001C0401200400300A02C2EF0F0056400A02A6F30F960188014C0BBE03161802C6EF0F00285E00540B8E011802C4EF0F00285A02C4EF0F040C0B90011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B9201161802BEEF0F00283200120B9401161802BEEF0F002832005A0B8C01161802BEEF0F00283200620B8A01161802BCEF0F00285400760B181802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B8201161802BEEF0F002832007C0B16161802B2EF0F002842000BD001180286F00F0028400486F00F12140A02A6F30F00281A04001E0A02ECEF0F0062240BF201161802C4F10F00286C002C0400300400400BF4011802C4EF0F00285A02C4EF0F040C0BF6011802B6EF0F00289C0202B6EF0F020C0A02BAEF0F009E02120BF801161802BEEF0F002832040BFA011802CEEF0F00283602CEEF0F04100A02A6F30F0028160BFC01161802BEEF0F002832000BFE011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B8002161802BEEF0F002832004C0400500400A4F10F1A0A0332E4BF9DE5AD98E8A786E59BBE24E9A284E8AEBEE8A786E59BBE0E03207361766556696577246275696C74696E1804001C0401200400300A02C2EF0F0056400A02A6F30F960188014C0BF001161802C6EF0F00285E00540BE6011802C4EF0F00285A02C4EF0F040C0BE8011802B6EF0F00289C0202B6EF0F020C0A02BAEF0F009E02120BEA01161802BEEF0F002832020BEC011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BEE01161802BEEF0F002832005A0BE401161802BEEF0F00283200620BE201161802BCEF0F00285400760BDA011802B6EF0F00289C0202B6EF0F020C0A02BAEF0F009E027C0BD201161802B2EF0F002842020BD4011802B2EF0F00284202B2EF0F0840030CE8A786E59BBE440308566965774E0BD6011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BD801161802BEEF0F00283200600A02A6F30FD001400BA001180286F00F0028400486F00F10140A02A6F30F00281A04011E0A02ECEF0F0062240BC001161802C4F10F00286C002C04003004004C0400500400A4F10F1A0A034CE698A0E5B08424E7B1BBE59E8BE8BDACE68DA2E88A82E782B95FE9A284E8AEBEE8A786E59BBE0E034A6D617024746563685F6D657461766D5F666C6F775F436173744E6F64655F6275696C74696E1804001C0401200400300A02C2EF0F0056400A02A6F30F960188014C0BBE01161802C6EF0F00285E00540BB2011802C4EF0F00285A02C4EF0F040C0BB4011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BB601161802BEEF0F00283200120BB801161802BEEF0F002832020BBA011802CEEF0F00283602CEEF0F04100A02A6F30F0028160BBC01161802BEEF0F002832005A0BB001161802BEEF0F00283200620BAE01161802BCEF0F00285400760BAA011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BAC01161802BEEF0F002832007C0BA201161802B2EF0F002842020BA4011802B2EF0F00284202B2EF0F0840030CE69DA5E6BA9044030C736F757263654E0BA6011802CEEF0F00283602CEEF0F04100A02A6F30F0028160BA801161802BEEF0F00283200600A02A6F30FA001400BC201180286F00F0028400486F00F10140A02A6F30F00281A04011E0A02ECEF0F0062240B9402161802C4F10F00286C002C04003004004C0400500400A4F10F1A0A0352E58F8DE698A0E5B08424E7B1BBE59E8BE8BDACE68DA2E88A82E782B95FE9A284E8AEBEE8A786E59BBE0E034E756E6D617024746563685F6D657461766D5F666C6F775F436173744E6F64655F6275696C74696E1804001C0401200400300A02C2EF0F0056400A02A6F30F960188014C0B9202161802C6EF0F00285E00540B86021802C4EF0F00285A02C4EF0F040C0B88021802CEEF0F00283602CEEF0F04100A02A6F30F0028160B8A02161802BEEF0F00283200120B8C02161802BEEF0F002832020B8E021802CEEF0F00283602CEEF0F04100A02A6F30F1A28160B9002161802BEEF0F002832005A0B8402161802BEEF0F00283200620B8202161802BCEF0F00285400760BCC011802CEEF0F00283602CEEF0F04100A02A6F30F0028160BCE01161802BEEF0F002832007C0BC401161802B2EF0F002842020BC6011802B2EF0F00284202B2EF0F0840030CE8A786E59BBE440308766965774E0BC8011802CEEF0F00283602CEEF0F04100A02A6F30F1A28160BCA01161802BEEF0F00283200600A02A6F30FC20140F2030B0A161802E8EF0F00281C020B0C1802E8EF0F00281C02E8EF0F16180306E580BC1C030C6F626A656374260A02A6F30F00282C0A02ECEF0F0062320400400400440A02EEEF0F007CEA0104019002040094020A02C2EF0F00569A020B0E1802CEEF0F00283602CEEF0F04100A0282F00F0028160B10161802BEEF0F00283200FA030B08151802A0EF0F0028280082040B06161802CEEF0F002836008A040B021802CEEF0F00283602CEEF0F04100A028CF20F0028160B04161802BEEF0F00283200A8F10F020A0401";

    public static void main(String[] args) throws IOException {
        var id = (TaggedPhysicalId) Id.parse("02a6f30f9c028601");
//        var rootId = new TaggedPhysicalId(id.getTreeId(), 0L, 20);
//        System.out.println(id.getClass().getName());
        System.out.println("treeId: " + id.getTreeId());
        System.out.println("nodeId: " + id.getNodeId());
        System.out.println("typeTag: " + id.getTypeTag());
//        System.out.println(rootId);
        var bytes = EncodingUtils.hexToBytes(hex);
//        System.out.println(NncUtils.toPrettyJsonString(BytesUtils.convertToJSON(bytes, true)));

        new StreamVisitor(new ByteArrayInputStream(bytes)) {

            private final LinkedList<Id> path = new LinkedList<>();

            @Override
            public void visitRecordBody(long nodeId, TypeOrTypeKey typeOrTypeKey) {
                var curId = PhysicalId.of(getTreeId(), nodeId, typeOrTypeKey);
                path.addLast(curId);
                if (curId.equals(id)) {
                    System.out.println(NncUtils.join(path, Id::toString, "->"));
                    System.out.println(NncUtils.join(path, id -> id instanceof TaggedPhysicalId tpId ? tpId.getTypeTag() + "" : "0", "->"));
                }
                super.visitRecordBody(nodeId, typeOrTypeKey);
                path.removeLast();
            }
        }.visitMessage();

    }


}
